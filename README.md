# ELFI：事件溯源的文学化文件解释器

本文档基于其技术设计文档，对 `elfi` 项目进行概述。它将作为 Gemini/Claude 代理的持久化上下文，以帮助其理解项目的目标、架构和术语。

## 📖 开发者文档

如果你是开发者或贡献者，请查看以下文档：

- **[CONTRIBUTING.md](CONTRIBUTING.md)** - 贡献者指南，包含快速开始、项目结构、开发命令等
- **[DEVELOPMENT.md](DEVELOPMENT.md)** - 详细的开发环境配置指南，包括多平台安装说明
- **[docs/README.md](docs/README.md)** - 文档构建和维护指南
- **[scripts/README.md](scripts/README.md)** - 自动化脚本使用说明

**重要笔记：**
- **文档结构**: 所有需要通过 `mdbook` 编译的文档源文件（`.md` 文件）都**必须**放置在 `docs/src/` 目录下。`docs/src/SUMMARY.md` 文件定义了最终文档的目录结构。

## 项目愿景

**`elfi` (Event-sourcing Literate File Interpreter)** 是一种全新的文学化编程范式，围绕 `.elf` 文件格式构建。它从零开始设计，旨在实现原生的、去中心化的协作，以克服现有工具（如 Jupyter Notebooks、LaTeX 和 Org-mode）的局限性。

其目标是为软件工程和科学研究中的人机协作，创造一个强大、透明且高效的媒介。

## 核心原则

- **解析器优先 & 人类可读：** `.elf` 是一种纯文本格式，既对人类友好，又易于解析为丰富的、结构化的内存数据模型。它的设计对 Git 等版本控制系统非常友好。
- **原生协作：** 数据模型建立在**无冲突复制数据类型 (CRDTs)** 之上，支持无缝的并发和离线编辑，同时保证最终一致性。
- **事件溯源：** 文档不是一个静态文件，而是一个可重放的、不可变的所有操作（变更）日志。这提供了极高的透明度、可审计性和强大的版本历史。
- **去中心化 & 网络无关：** 该架构支持各种网络拓扑（P2P、客户端-服务器、网状），且不依赖于单一中央服务器，确保了数据主权。

## 系统架构

`elfi` 系统由几个不同的层次组成，并在一个模块化的 Rust 内核中实现。

### 1. 数据模型 (CRDT 核心)

- **基础：** 建立在**事件溯源**和受 **Automerge 启发的 CRDT** 模型之上。与注重性能的 CRDT（如 Yjs）不同，它保留了完整的、不可变的操作历史。
- **结构：** 文档是一个扁平的 "Block" 对象列表。每个块都是一个 CRDT Map (`id`, `type`, `content`, `metadata`)。
- **层级结构：** 丰富的层级结构（如章节、小节）通过**邻接列表模型**来表示。父块的 `id` 存储在子块的 `metadata` 中，从而在一个扁平的数据结构之上创建了逻辑嵌套。这简化了并发的移动操作。
- **冲突解决：** 实现了一种块感知的、语义化的冲突解决策略。它不依赖于默认的 CRDT 行为，而是可以针对代码使用三方合并等策略，或将冲突暴露给 UI 进行手动解决。

### 2. 存储与同步 (Zenoh 网络)

- **协议：** 使用 **Eclipse Zenoh** 作为一个统一的发布/订阅、分布式查询和存储网络。
- **机制：** CRDT 操作作为消息发布到每个文档唯一的键空间（例如 `/elf/docs/<doc_uuid>/ops`）。客户端订阅此键空间以获取实时更新，并查询它以获取历史操作。
- **持久化：** 通过 Zenoh 的存储后端插件实现解耦。操作日志可以存储在文件系统、RocksDB、InfluxDB 或任何自定义数据库中，而无需更改 `elfi` 的核心逻辑。

### 3. Weave API (内容创作层)

- **目的：** 为主要内容贡献者（程序员、作者）提供的高级 API。
- **模型：** 实现了一个**仓库 (`Repo`) 模型**，抽象了网络和存储的复杂性。开发者通过 `DocHandle` 与文档进行交互以修改文档。
- **功能：** 提供 `change()`、`subscribe()`、`getHistory()` 和 `viewAt()` (用于时间旅行) 等方法，以及用于导航逻辑层级 (`getParent`, `getChildren`) 的辅助函数。

### 4. Tangle API (交互式渲染层)

- **目的：** 为渲染 `.elf` 文档交互式视图的 UI 客户端提供的 API。
- **模型：** 基于**孤岛架构**。文档被渲染为静态 HTML（“海洋”），其中包含可选择性“激活”的交互式组件（“孤岛”）。
- **状态管理：** 在以下两者之间创建了清晰的界限：
    - **本地/临时 UI 状态：** 在每个孤岛内部管理（例如，拖动滑块时的当前位置）。
    - **全局/持久化状态：** CRDT 文档，作为共享的状态总线。
- **固定 (Pinning)：** 提供一个 `pinBlockState()` API，供孤岛将其重要的状态变更提交回 CRDT，使其持久化并与协作者共享。

### 5. `elfi` 解释器 (Rust 内核)

- **实现：** 一个用 **Rust** 编写的无头内核，以实现高性能和安全性。
- **核心依赖：**
    - **`tree-sitter`：** 用于将 `.elf` 文本格式解析为 AST。
    - **`automerge`：** 用于内存中的 CRDT 数据模型。
    - **`zenoh`：** 用于所有网络和同步。
- **结构：** 一个 Cargo 工作区，包含模块化的 crates：
    - `elfi-core`：暴露 Weave 和 Tangle API 的主库。
    - `elfi-parser`：Tree-sitter 语法和解析逻辑。
    - `elfi-cli`：用于离线文件管理的命令行工具。
    - `elfi-ffi`：一个 C 兼容的 FFI 层，用于绑定到其他语言和 WebAssembly。
- **代码执行：** 包含一个通过 Jupyter 协议与外部代码执行内核交互的模块。

---

**Agent Instructions:**

请总是使用中文进行回复，但使用英文的技术词汇。